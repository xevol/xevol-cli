# XEVol CLI — Code Review & E2E Test Report

**Date:** 2026-02-02  
**Reviewer:** Automated (Claude)  
**Scope:** All commits from 2026-02-02 across xevol-cli, xevol-api, xevol.com

---

## 1. End-to-End Functional Test Results

| # | Command | Result | Notes |
|---|---------|--------|-------|
| 1 | `xevol whoami` | ✅ PASS | Returns `kukabynd@gmail.com` |
| 2 | `xevol list --limit 3` | ✅ PASS | Table with 3 rows, pagination info correct (page 1/286, 858 total) |
| 3 | `xevol list --limit 3 --csv` | ✅ PASS | Clean CSV with headers, proper quoting of commas in titles |
| 4 | `xevol list --limit 3 --json` | ✅ PASS | Valid JSON with list, page, limit, total, totalPages |
| 5 | `xevol prompts` | ✅ PASS | Table with 51 prompts, ID and Name columns |
| 6 | `xevol prompts --csv` | ✅ PASS | Clean CSV output with ID,Name headers |
| 7 | `xevol view aPw4REDODVS` | ✅ PASS | Title, channel, duration, summary displayed correctly |
| 8 | `xevol spikes 7LIGrZOLbK7 --prompt review` | ✅ PASS | Generated review spike, content rendered to terminal |
| 9 | `xevol add <url> --wait --spikes review` | ⚠️ PARTIAL | Transcription created (ZilJPCE06_e), processing started. Timed out after 2min (expected for real video transcription) |
| 10 | `xevol --help` | ✅ PASS | All commands listed: login, logout, whoami, list, add, view, spikes, prompts, stream, resume |

**Overall: 9/10 pass, 1 partial (expected timeout for long-running operation)**

---

## 2. Code Quality Review

### 2.1 Issues Found

#### CRITICAL — None found

#### HIGH

**H1. Auth bypass on SSE stream endpoint (spikes.ts API)**  
**File:** `~/stack/xevol-api/src/routes/spikes.ts` (line ~100, `/spikes/stream/:spikeId`)  
**Severity:** HIGH  
The stream endpoint uses `tryAttachUser` but does **not** use `requireAuth` or `allowGuests`. Any unauthenticated request can access any spike stream. The ownership check (`spike.accountId !== accountId`) is commented out.  
**Impact:** Any user with a valid spike ID can stream another user's spike content.

**H2. Missing auth on `/v1/prompts` endpoint**  
**File:** `~/stack/xevol-api/src/routes/v1/transcription.ts`  
**Severity:** HIGH (information disclosure)  
The `GET /v1/prompts` endpoint has no authentication middleware at all — no `tryAttachUser`, no `requireAuth`. While prompt names may not be sensitive, the endpoint exposes the full prompt text (truncated to 200 chars). This is likely intentional (public endpoint), but should be documented as a design decision.

**H3. Duplicate POST on spike polling (add.ts polling mode)**  
**File:** `~/stack/xevol-cli/src/commands/add.ts` (line ~140, polling mode)  
**Severity:** HIGH (correctness)  
In polling mode, the CLI re-POSTs `POST /spikes/:id` every 5 seconds to check if a spike is ready. This is creating a new spike each poll iteration (though the API is idempotent due to the duplicate check). However, if the duplicate check fails (DB error), the catch block re-queries using the **original** `transcriptionId` instead of the cloned one (`transcription.id`), potentially returning the wrong spike.

#### MEDIUM

**M1. Race condition in cloneTranscription**  
**File:** `~/stack/xevol-api/src/lib/transcription.ts`  
**Severity:** MEDIUM  
The function checks for existing copy, then inserts. Two concurrent requests could both pass the check and attempt to insert, causing a duplicate. The catch block in `spikes.ts` handles `"already exists"` errors, but `cloneTranscription` itself doesn't — the caller in `transcription.ts` (the clone endpoint) would get a 500.

**M2. `updateSpikeState` is exported but never used**  
**File:** `~/stack/xevol-cli/src/lib/jobs.ts`  
**Severity:** MEDIUM (dead code)  
`updateSpikeState` is imported in `add.ts` but never called. It's exported from `jobs.ts` but unused anywhere.

**M3. No AbortController / timeout on SSE streams**  
**File:** `~/stack/xevol-cli/src/lib/sse.ts`  
**Severity:** MEDIUM  
The SSE client accepts an optional `signal` but none of the callers (`stream.ts`, `add.ts`, `resume.ts`) pass one. A hung SSE connection will block the CLI indefinitely. Users must Ctrl+C to escape.

**M4. CSV output doesn't escape newlines properly**  
**File:** `~/stack/xevol-cli/src/commands/list.ts`  
**Severity:** MEDIUM  
The `csvQuote` function handles commas, double quotes, and newlines by wrapping in quotes. However, if a title contains a literal `\n` (not unusual in YouTube titles), the CSV line break will corrupt the output. Should replace `\n` with a space or use proper CSV library.

**M5. `pickSessionField` doesn't check for `id` field type conflicts**  
**File:** `~/stack/xevol-cli/src/lib/utils.ts`  
**Severity:** MEDIUM  
`pickSessionField` only returns strings. If `accountId` is returned as a number by the API (some ORMs do this), it would return `undefined`. The `pickNumberField` pattern exists but isn't used for ID fields.

**M6. Inconsistent error handling in spikes POST catch block**  
**File:** `~/stack/xevol-api/src/routes/spikes.ts` (line ~75)  
**Severity:** MEDIUM  
The catch block checks `dbError?.cause?.detail?.includes("already exists")` which is fragile — it depends on PostgreSQL's exact error message format and the error chain structure. A constraint violation might not always have this exact path.

#### LOW

**L1. Hardcoded output language "en" in resume.ts**  
**File:** `~/stack/xevol-cli/src/commands/resume.ts` (line ~55, ~100)  
**Severity:** LOW  
When resuming, the output language is hardcoded to `"en"` instead of being stored in the job state. If the original add used `--lang kk`, the resume would request English.

**L2. Magic number 120 for max poll attempts**  
**File:** `~/stack/xevol-cli/src/commands/add.ts`, `spikes.ts`  
**Severity:** LOW  
`maxAttempts = 120` with 5s sleep = 10 minutes timeout, but this isn't configurable or documented.

**L3. `cached` module-level mutable state in transcription.ts API**  
**File:** `~/stack/xevol-api/src/routes/v1/transcription.ts`  
**Severity:** LOW  
The `cached` object is module-level mutable state with a 10ms setTimeout cleanup. This is a process-scoped cache that won't work correctly across multiple API instances/workers.

**L4. Console.log debug statements left in API**  
**File:** `~/stack/xevol-api/src/routes/v1/transcription.ts` (line ~90: `console.log("/v1/add get request")`, line ~155: `console.log(124, sessionToken)`)  
**Severity:** LOW  
Debug logging left in production code. The `console.log(124, sessionToken)` is especially concerning as it logs the session token to stdout.

**L5. `formatExpiry` never used outside login.ts**  
**File:** `~/stack/xevol-cli/src/commands/login.ts`  
**Severity:** LOW  
Minor: could be a utility, but it's fine scoped to the file.

**L6. Comment says "accountId" but field is `id`**  
**File:** `~/stack/xevol-api/src/routes/auth/index.ts` (CLI token branch)  
**Severity:** LOW  
Comment says "Same user payload shape as browser sessions" but the CLI branch manually constructs the user object while the browser branch uses `userRepository.findById()` — if the repository adds new fields, the CLI branch won't have them.

---

### 2.2 Comments Accuracy

The inline documentation added today is **excellent** — comprehensive, accurate, and well-structured. Specific findings:

- ✅ `cli-auth.tsx` — Flow documentation matches implementation perfectly. UI states are well-documented.
- ✅ `cli.ts` — RFC 8628 reference is appropriate. State machine documentation is clear and matches the code.
- ✅ `middleware.ts` — Auth chain priority documented accurately. The distinction between `sessionId` being set (browser) vs not (CLI) is well-explained.
- ✅ `login.ts` — Device flow steps 1-5 match the implementation.
- ✅ `api.ts` — Good explanation of Bearer token pattern and smart method defaulting.
- ✅ `utils.ts` — `pickSessionField` duck typing approach well-documented with the three nesting levels.
- ✅ `sse.ts` — SSE spec compliance noted (leading space after colon).
- ⚠️ `spikes.ts` API — The commented-out ownership check has no comment explaining why it's disabled.

---

### 2.3 Type Safety

- **Good:** TypeScript types are used throughout. Interfaces defined for options, job state, SSE events.
- **Concern:** Heavy use of `as Record<string, unknown>` casting from `apiFetch` responses. Consider defining response types (e.g., `ListResponse`, `SpikeResponse`) to catch API contract changes at compile time.
- **Concern:** `any` used in `cli-auth.tsx` for `sessionUser` state — should be typed or at least `unknown`.

---

### 2.4 Security

- ✅ CLI tokens use `xevol_cli_` prefix to distinguish from other Bearer tokens
- ✅ Device flow uses separate device code (secret) and user code (public)
- ✅ Approval requires browser session (not CLI token) — prevents token escalation
- ✅ Tokens are soft-deleted on revoke, checked on every request
- ✅ Job state files written with mode `0o600`
- ⚠️ `console.log(124, sessionToken)` in API leaks session tokens to logs (L4)
- ⚠️ Stream endpoint has no auth enforcement (H1)

---

### 2.5 Code Duplication

| Duplicated Pattern | Files | Suggestion |
|---|---|---|
| Auth boilerplate (readConfig, resolveToken, check expired) | All command files | Extract `withAuth(fn)` wrapper |
| CSV quoting logic | `list.ts`, `prompts.ts` | Extract `csvQuote` to `utils.ts` |
| Spike polling loop | `add.ts`, `spikes.ts` | Both have identical polling patterns — extract shared helper |
| `getBearerToken` helper | `cli.ts`, `middleware.ts` | Duplicated verbatim — extract to shared util |
| User object construction | `auth/index.ts` (CLI vs browser branches) | Extract `formatUserPayload(userData)` |

---

## 3. Overall Assessment

### What went well
- **Clean architecture**: Device flow implementation follows RFC 8628 closely. State machine is well-designed.
- **Excellent documentation**: The inline comments are thorough, accurate, and genuinely helpful.
- **Resilient CLI design**: Duck-typing API responses (`pickValue`, `pickSessionField`) makes the CLI robust against API changes.
- **SSE implementation**: Clean async generator pattern, proper SSE spec parsing, resume support via Last-Event-ID.
- **Job state for resume**: Thoughtful design storing state locally for reconnection.

### What needs attention
1. **Stream endpoint auth** (H1) — Most important fix. Add `requireAuth` or `allowGuests` after `tryAttachUser`.
2. **Remove debug console.logs** (L4) — Especially the session token logging.
3. **Add timeouts to SSE** (M3) — Pass AbortController signals to prevent hung connections.
4. **Store output language in job state** (L1) — For correct resume behavior.
5. **Type API responses** — Move away from `Record<string, unknown>` to proper interfaces.

### Rating: **7.5/10**
Solid feature additions with good documentation. The main gaps are in auth enforcement on the stream endpoint and some rough edges in error handling. The codebase is well-structured and the CLI UX is polished.
